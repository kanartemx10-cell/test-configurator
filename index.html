<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Eman Configurator (Telegram)</title>
    
    <script src="https://telegram.org/js/telegram-web-app.js"></script>

    <style>
        :root { 
            /* –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ —Ç–µ–º—ã Telegram –¥–ª—è –Ω–∞—Ç–∏–≤–Ω–æ—Å—Ç–∏ */
            --tg-theme-bg-color: var(--tg-theme-bg-color, #fff);
            --tg-theme-text-color: var(--tg-theme-text-color, #222);
            --tg-theme-button-color: var(--tg-theme-button-color, #2481cc);
            --tg-theme-button-text-color: var(--tg-theme-button-text-color, #fff);
            
            --primary: #28a745; 
            --accent: #007bff; 
            --bg: #f4f7f6; 
        }

        body { 
            margin: 0; overflow: hidden; 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            display: flex; height: 100vh; 
            background: var(--bg);
            color: var(--tg-theme-text-color);
        }
        
        /* –°–ê–ô–î–ë–ê–† (–ú–µ–Ω—é) */
        #sidebar {
            width: 360px; 
            background: var(--tg-theme-bg-color); 
            padding: 20px; 
            border-right: 1px solid #e1e4e8; 
            display: flex; flex-direction: column;
            z-index: 100; 
            box-shadow: 4px 0 20px rgba(0,0,0,0.05); 
            overflow-y: auto;
        }

        #canvas-container { 
            flex-grow: 1; height: 100%; position: relative; 
            background: radial-gradient(circle at center, #f8f9fa 0%, #eef2f5 100%); 
        }

        h2 { margin: 0 0 15px 0; font-size: 20px; font-weight: 700; border-bottom: 2px solid #f0f0f0; padding-bottom: 10px; }
        h3 { margin: 15px 0 8px; font-size: 13px; color: #888; text-transform: uppercase; font-weight: 700; }

        /* –í–´–ë–û–† –°–ò–°–¢–ï–ú–´ */
        .system-select {
            width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 10px;
            font-size: 14px; background: var(--tg-theme-bg-color); color: var(--tg-theme-text-color);
            cursor: pointer; margin-bottom: 15px; outline: none;
        }
        .system-select:focus { border-color: var(--accent); }

        /* DROP ZONE */
        .drop-zone-container { display: none; }
        .drop-zone-container.active { display: block; }
        .file-drop-zone {
            border: 2px dashed #cbd5e0; border-radius: 8px; padding: 10px;
            text-align: center; cursor: pointer; transition: 0.2s; background: rgba(0,0,0,0.03);
            margin-bottom: 5px; position: relative; font-size: 12px; color: #666;
        }
        .file-drop-zone input { position: absolute; top:0; left:0; width:100%; height:100%; opacity: 0; cursor: pointer; }
        
        .toggle-custom {
            font-size: 12px; color: var(--accent); text-decoration: underline; cursor: pointer; 
            text-align: center; margin-bottom: 15px; display: block;
        }

        /* –°–õ–ê–ô–î–ï–†–´ */
        .slider-box { background: rgba(0,0,0,0.02); border: 1px solid rgba(0,0,0,0.05); border-radius: 10px; padding: 12px; margin-bottom: 10px; }
        .slider-header { display: flex; justify-content: space-between; margin-bottom: 5px; font-size: 14px; font-weight: 600; }
        .slider-val { color: var(--accent); }
        .slider-limits { display: flex; justify-content: space-between; font-size: 10px; color: #999; margin-top: 5px; }
        input[type=range] { width: 100%; cursor: pointer; accent-color: var(--accent); }

        /* –ú–ê–¢–ï–†–ò–ê–õ–´ */
        .mat-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px; }
        .mat-item {
            aspect-ratio: 1; border-radius: 50%; cursor: pointer; border: 2px solid #e2e8f0;
            transition: transform 0.2s; position: relative;
        }
        .mat-item.active { border-color: var(--tg-theme-button-color); transform: scale(1.15); box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        
        /* –ö–ù–û–ü–ö–ò */
        .footer-actions { margin-top: auto; padding-top: 20px; display: grid; gap: 10px; }
        .btn {
            border: none; padding: 14px; border-radius: 10px; 
            font-weight: 600; font-size: 15px; cursor: pointer; 
            display: flex; align-items: center; justify-content: center; gap: 8px;
            transition: 0.2s; box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .btn:hover { transform: translateY(-2px); opacity: 0.9; }
        
        /* –û—Å–Ω–æ–≤–Ω–∞—è –∫–Ω–æ–ø–∫–∞ Telegram (–°–∏–Ω—è—è) */
        .btn-tg { 
            background: var(--tg-theme-button-color); 
            color: var(--tg-theme-button-text-color); 
        }
        .btn-ar { background: #343a40; color: white; }
        
        /* –ú–∞–ª–µ–Ω—å–∫–∞—è —Å—Å—ã–ª–∫–∞ –¥–ª—è ZIP */
        .link-zip {
            text-align: center; font-size: 12px; color: #999; text-decoration: underline; 
            cursor: pointer; margin-top: 5px;
        }

        #loader {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: rgba(255,255,255,0.9); padding: 15px 30px; border-radius: 50px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1); font-weight: 600; display: none; color: #000;
        }

        /* –ê–¥–∞–ø—Ç–∏–≤ –¥–ª—è Telegram Mobile */
        @media (max-width: 768px) {
            body { flex-direction: column; }
            #canvas-container { height: 40vh; order: 1; }
            #sidebar { 
                width: 100%; height: 60vh; order: 2; 
                border-radius: 20px 20px 0 0; 
                box-sizing: border-box; 
                box-shadow: 0 -5px 20px rgba(0,0,0,0.1);
            }
        }
    </style>

    <script type="importmap">
        { "imports": { "three": "https://unpkg.com/three@0.160.0/build/three.module.js", "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/" } }
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script type="module" src="https://ajax.googleapis.com/ajax/libs/model-viewer/3.4.0/model-viewer.min.js"></script>
</head>
<body>

<div id="sidebar">
    <h2>Eman Configurator</h2>

    <h3>1. –¢–∏–ø —Å–∏—Å—Ç–µ–º—ã</h3>
    
    <select id="preset-select" class="system-select" onchange="app.loadPreset()">
        <option value="" disabled selected>-- –í—ã–±–µ—Ä–∏—Ç–µ —à–∫–∞—Ñ --</option>
        </select>

    <div class="toggle-custom" onclick="document.querySelector('.drop-zone-container').classList.toggle('active')">
        –ó–∞–≥—Ä—É–∑–∏—Ç—å —Å–≤–æ–π —Ñ–∞–π–ª (OBJ/JSON)...
    </div>

    <div class="drop-zone-container">
        <div class="file-drop-zone" id="zone-obj">
            <span>üì¶ OBJ</span>
            <input type="file" id="input-obj" accept=".obj">
        </div>
        <div class="file-drop-zone" id="zone-json">
            <span>‚öôÔ∏è JSON</span>
            <input type="file" id="input-json" accept=".json">
        </div>
    </div>

    <h3>2. –ì–∞–±–∞—Ä–∏—Ç—ã</h3>
    
    <div class="slider-box">
        <div class="slider-header"><span>–®–∏—Ä–∏–Ω–∞</span> <span class="slider-val" id="val-w">-</span></div>
        <input type="range" id="range-w" disabled oninput="app.updateDims()">
        <div class="slider-limits"><span id="min-w">0</span><span id="max-w">0</span></div>
    </div>

    <div class="slider-box">
        <div class="slider-header"><span>–í—ã—Å–æ—Ç–∞</span> <span class="slider-val" id="val-h">-</span></div>
        <input type="range" id="range-h" disabled oninput="app.updateDims()">
        <div class="slider-limits"><span id="min-h">0</span><span id="max-h">0</span></div>
    </div>
    
    <div class="slider-box">
        <div class="slider-header"><span>–ì–ª—É–±–∏–Ω–∞</span> <span class="slider-val" id="val-d">-</span></div>
        <input type="range" id="range-d" disabled oninput="app.updateDims()">
        <div class="slider-limits"><span id="min-d">0</span><span id="max-d">0</span></div>
    </div>

    <h3>3. –û—Ç–¥–µ–ª–∫–∞</h3>
    <div style="font-size:12px; color:#999; margin-bottom:5px;">–ö–æ—Ä–ø—É—Å</div>
    <div class="mat-grid" id="mat-body"></div>
    <div style="font-size:12px; color:#999; margin:10px 0 5px;">–§–∞—Å–∞–¥—ã</div>
    <div class="mat-grid" id="mat-facade"></div>

    <div class="footer-actions">
        <button class="btn btn-tg" onclick="app.sendToTelegram()">
            üöÄ –û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞–∫–∞–∑ –≤ —á–∞—Ç
        </button>
        
        <button class="btn btn-ar" onclick="app.openAR()">
            üì± AR (–ü—Ä–∏–º–µ—Ä–∏—Ç—å)
        </button>
        
        <div class="link-zip" onclick="app.exportArchive()">–°–∫–∞—á–∞—Ç—å ZIP –∞—Ä—Ö–∏–≤ (—Ä–µ–∑–µ—Ä–≤)</div>
    </div>
</div>

<div id="canvas-container">
    <div id="loader">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
    <model-viewer id="ar-viewer" ar ar-modes="webxr scene-viewer quick-look" camera-controls style="display: none;"></model-viewer>
</div>

<script type="module">
    import * as THREE from 'three';
    import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
    import { OBJLoader } from 'three/addons/loaders/OBJLoader.js';
    import { OBJExporter } from 'three/addons/exporters/OBJExporter.js';
    import { GLTFExporter } from 'three/addons/exporters/GLTFExporter.js';

    // --- –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø TELEGRAM ---
    const tg = window.Telegram.WebApp;
    tg.ready();
    tg.expand(); // –†–∞–∑–≤–µ—Ä–Ω—É—Ç—å –Ω–∞ –≤–µ—Å—å —ç–∫—Ä–∞–Ω

    // --- –ë–ê–ó–ê –î–ê–ù–ù–´–• –®–ö–ê–§–û–í ---
    const PRESETS = {
        "salice_l70": {
            name: "Salice L70 Flex",
            url: "models/salice_l70.obj",
            limits: { minW: 1740, maxW: 3400, minH: 1800, maxH: 2700, minD: 400, maxD: 900 },
            defaults: { w: 2400, h: 2600, d: 650 }
        },
        "salice_m50": {
            name: "Salice M50 Flex",
            url: "models/salice_m50.obj",
            limits: { minW: 2340, maxW: 3200, minH: 1800, maxH: 2700, minD: 400, maxD: 900 },
            defaults: { w: 2800, h: 2600, d: 650 }
        },
        "hettich_tl": {
            name: "Hettich TopLine XL",
            url: "models/hettich_tl.obj",
            limits: { minW: 1200, maxW: 4000, minH: 2000, maxH: 3000, minD: 500, maxD: 800 },
            defaults: { w: 2000, h: 2400, d: 600 }
        },
        "wingline": {
            name: "Hettich WingLine L",
            url: "models/wingline.obj",
            limits: { minW: 500, maxW: 2400, minH: 1000, maxH: 2600, minD: 350, maxD: 700 },
            defaults: { w: 1200, h: 2200, d: 550 }
        }
    };

    let currentModel = null;
    let baseDims = { w: 1, h: 1, d: 1 };
    let currentConfig = { name: "Custom", w: 1000, h: 1000, d: 600 };
    
    const MATERIALS = [
        { name: "–ë–µ–ª—ã–π", color: "#f7f7f7" },
        { name: "–°–µ—Ä—ã–π", color: "#8c8c8c" },
        { name: "–ì—Ä–∞—Ñ–∏—Ç", color: "#333333" },
        { name: "–ö–∞—à–µ–º–∏—Ä", color: "#d1c7b6" },
        { name: "–î—É–±", color: "#8b5a2b" }
    ];
    let selBody = MATERIALS[0];
    let selFacade = MATERIALS[0];

    // --- 3D SCENE ---
    const scene = new THREE.Scene();
    const container = document.getElementById('canvas-container');
    const camera = new THREE.PerspectiveCamera(45, container.clientWidth / container.clientHeight, 100, 20000);
    camera.position.set(2500, 1800, 3500);

    const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true, preserveDrawingBuffer: true });
    renderer.setSize(container.clientWidth, container.clientHeight);
    renderer.shadowMap.enabled = true;
    container.appendChild(renderer.domElement);

    const controls = new OrbitControls(camera, renderer.domElement);
    controls.enableDamping = true;
    controls.maxPolarAngle = Math.PI / 2 - 0.05;

    const hemiLight = new THREE.HemisphereLight(0xffffff, 0xebf4fa, 0.6);
    scene.add(hemiLight);
    const dirLight = new THREE.DirectionalLight(0xffffff, 0.8);
    dirLight.position.set(1500, 3000, 2000);
    dirLight.castShadow = true;
    scene.add(dirLight);
    const shadowPlane = new THREE.Mesh(new THREE.PlaneGeometry(10000, 10000), new THREE.ShadowMaterial({ opacity: 0.1 }));
    shadowPlane.rotation.x = -Math.PI / 2;
    shadowPlane.receiveShadow = true;
    scene.add(shadowPlane);

    // --- LOGIC ---
    const app = {
        init: () => {
            const select = document.getElementById('preset-select');
            for (const [key, val] of Object.entries(PRESETS)) {
                const opt = document.createElement('option');
                opt.value = key;
                opt.innerText = val.name;
                select.appendChild(opt);
            }
            app.renderPalette('mat-body', 'body');
            app.renderPalette('mat-facade', 'facade');
            
            // –ó–∞–≥—Ä—É–∑–∫–∞ —Ç–µ–º—ã –∏–∑ Telegram
            if (tg.colorScheme === 'dark') {
                document.documentElement.style.setProperty('--bg', '#1c1c1e');
            }
        },

        loadPreset: () => {
            const key = document.getElementById('preset-select').value;
            const preset = PRESETS[key];
            if (!preset) return;

            app.setupSlider('range-w', preset.limits.minW, preset.limits.maxW, preset.defaults.w);
            app.setupSlider('range-h', preset.limits.minH, preset.limits.maxH, preset.defaults.h);
            app.setupSlider('range-d', preset.limits.minD, preset.limits.maxD, preset.defaults.d);
            
            currentConfig.name = preset.name;
            app.loadOBJ(preset.url, true);
        },

        loadOBJ: (url, isPreset = false) => {
            document.getElementById('loader').style.display = 'block';
            if (currentModel) scene.remove(currentModel);

            new OBJLoader().load(url, (obj) => {
                currentModel = obj;
                scene.add(obj);

                const box = new THREE.Box3().setFromObject(obj);
                const size = box.getSize(new THREE.Vector3());
                baseDims = { w: size.x, h: size.y, d: size.z };
                
                const center = box.getCenter(new THREE.Vector3());
                obj.position.x = -center.x;
                obj.position.y = -box.min.y;
                obj.position.z = -center.z;

                app.applyMaterials();
                app.updateDims(); 
                
                document.getElementById('loader').style.display = 'none';

                if (!isPreset) alert("–ú–æ–¥–µ–ª—å –∑–∞–≥—Ä—É–∂–µ–Ω–∞.");
            }, undefined, (err) => {
                alert("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: " + url + "\n(–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–∞–ø–∫—É models)");
                document.getElementById('loader').style.display = 'none';
            });
        },

        loadJSON: (text) => {
            try {
                const data = JSON.parse(text);
                const l = data.limits || {};
                const d = data.dimensions || {};
                
                app.setupSlider('range-w', l.minW||500, l.maxW||3000, d.w||1000);
                app.setupSlider('range-h', l.minH||1000, l.maxH||3000, d.h||2000);
                app.setupSlider('range-d', l.minD||300, l.maxD||1000, d.d||600);
                
                currentConfig.name = data.name || "Custom";
                app.updateDims();
                alert("–ù–∞—Å—Ç—Ä–æ–π–∫–∏ JSON –ø—Ä–∏–º–µ–Ω–µ–Ω—ã!");
            } catch (e) { alert("–û—à–∏–±–∫–∞ JSON"); }
        },

        setupSlider: (id, min, max, val) => {
            const el = document.getElementById(id);
            el.min = min; el.max = max; el.value = val; el.disabled = false;
            const parent = el.parentElement;
            parent.querySelector('#min-'+id.split('-')[1]).innerText = min;
            parent.querySelector('#max-'+id.split('-')[1]).innerText = max;
        },

        updateDims: () => {
            const w = document.getElementById('range-w').value;
            const h = document.getElementById('range-h').value;
            const d = document.getElementById('range-d').value;
            
            document.getElementById('val-w').innerText = w;
            document.getElementById('val-h').innerText = h;
            document.getElementById('val-d').innerText = d;

            if (currentModel) {
                currentModel.scale.set(w / baseDims.w, h / baseDims.h, d / baseDims.d);
            }
            currentConfig.w = w; currentConfig.h = h; currentConfig.d = d;
        },

        renderPalette: (containerId, type) => {
            const container = document.getElementById(containerId);
            MATERIALS.forEach((m, idx) => {
                const btn = document.createElement('div');
                btn.className = `mat-item ${idx===0 ? 'active' : ''}`;
                btn.style.backgroundColor = m.color;
                btn.onclick = () => {
                    container.querySelectorAll('.mat-item').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    if(type==='body') selBody = m; else selFacade = m;
                    app.applyMaterials();
                };
                container.appendChild(btn);
            });
        },

        applyMaterials: () => {
            if(!currentModel) return;
            const mBody = new THREE.MeshStandardMaterial({ color: selBody.color, roughness: 0.7 });
            const mFacade = new THREE.MeshStandardMaterial({ color: selFacade.color, roughness: 0.2, metalness: 0.1 });
            currentModel.traverse(child => {
                if(child.isMesh) {
                    const n = child.name.toLowerCase();
                    child.material = (n.includes('facade') || n.includes('door')) ? mFacade : mBody;
                }
            });
        },

        openAR: () => {
            if(!currentModel) return tg.showAlert("–°–Ω–∞—á–∞–ª–∞ –∑–∞–≥—Ä—É–∑–∏—Ç–µ –º–æ–¥–µ–ª—å!");
            const exporter = new GLTFExporter();
            exporter.parse(currentModel, (gltf) => {
                const blob = new Blob([gltf], { type: 'application/octet-stream' });
                const url = URL.createObjectURL(blob);
                const viewer = document.getElementById('ar-viewer');
                viewer.src = url; viewer.activateAR();
            }, (e) => console.error(e), { binary: true });
        },

        // --- –ì–õ–ê–í–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø –î–õ–Ø TELEGRAM ---
        sendToTelegram: () => {
            if(!currentModel) return tg.showAlert("–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ —à–∫–∞—Ñ!");

            // –§–æ—Ä–º–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ –∑–∞–∫–∞–∑–∞
            const orderData = {
                title: "–ù–æ–≤—ã–π –∑–∞–∫–∞–∑",
                model: currentConfig.name,
                size: `${currentConfig.w} x ${currentConfig.h} x ${currentConfig.d}`,
                body_color: selBody.name,
                facade_color: selFacade.name,
                date: new Date().toLocaleString()
            };

            // –ü—Ä–µ–≤—Ä–∞—â–∞–µ–º –≤ JSON —Å—Ç—Ä–æ–∫—É
            const dataString = JSON.stringify(orderData);

            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –±–æ—Ç—É
            // –ë–æ—Ç –ø–æ–ª—É—á–∏—Ç —ç—Ç–æ –∫–∞–∫ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å —Ç–∏–ø–æ–º "web_app_data"
            tg.sendData(dataString); 
            
            // –ü—Ä–∏–º–µ—á–∞–Ω–∏–µ: –ï—Å–ª–∏ –±–æ—Ç–∞-—Å–µ—Ä–≤–µ—Ä–∞ –Ω–µ—Ç, —ç—Ç–æ –∑–∞–∫—Ä–æ–µ—Ç –æ–∫–Ω–æ, –Ω–æ –Ω–∏—á–µ–≥–æ –Ω–µ –ø—Ä–æ–∏–∑–æ–π–¥–µ—Ç –≤ —á–∞—Ç–µ.
            // –ü–æ—ç—Ç–æ–º—É —è –æ—Å—Ç–∞–≤–∏–ª –∫–Ω–æ–ø–∫—É "–°–∫–∞—á–∞—Ç—å ZIP" –Ω–∏–∂–µ.
        },

        exportArchive: () => {
            if(!currentModel) return alert("–ù–µ—Ç –º–æ–¥–µ–ª–∏!");
            const zip = new JSZip();
            const fileName = `${currentConfig.name}_${currentConfig.w}x${currentConfig.h}`;

            const orderJson = {
                Model: currentConfig.name,
                Dimensions: { Width: currentConfig.w, Height: currentConfig.h, Depth: currentConfig.d },
                Materials: { Body: selBody.name, Facade: selFacade.name }
            };
            zip.file("order_params.json", JSON.stringify(orderJson, null, 2));

            const exporter = new OBJExporter();
            zip.file("visual_model.obj", exporter.parse(currentModel));
            zip.file("info.txt", `–ó–∞–∫–∞–∑: ${fileName}\n–ö–æ—Ä–ø—É—Å: ${selBody.name}\n–§–∞—Å–∞–¥: ${selFacade.name}`);

            zip.generateAsync({type:"blob"}).then(c => saveAs(c, fileName+".zip"));
        }
    };

    window.app = app;
    app.init();

    // –°–ª—É—à–∞—Ç–µ–ª–∏ —Ñ–∞–π–ª–æ–≤
    document.getElementById('input-obj').addEventListener('change', (e) => {
        if(e.target.files[0]) app.loadOBJ(URL.createObjectURL(e.target.files[0]));
    });
    document.getElementById('input-json').addEventListener('change', (e) => {
        if(e.target.files[0]) {
            const r = new FileReader();
            r.onload = (evt) => app.loadJSON(evt.target.result);
            r.readAsText(e.target.files[0]);
        }
    });

    function animate() { requestAnimationFrame(animate); controls.update(); renderer.render(scene, camera); }
    animate();
    window.addEventListener('resize', () => { camera.aspect = container.clientWidth/container.clientHeight; camera.updateProjectionMatrix(); renderer.setSize(container.clientWidth, container.clientHeight); });

</script>
</body>
</html>