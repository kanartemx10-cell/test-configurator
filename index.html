<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Eman Configurator v6.0</title>
    
    <script src="https://telegram.org/js/telegram-web-app.js"></script>

    <style>
        :root { 
            --tg-theme-bg-color: var(--tg-theme-bg-color, #fff);
            --tg-theme-text-color: var(--tg-theme-text-color, #222);
            --tg-theme-button-color: var(--tg-theme-button-color, #2481cc);
            --tg-theme-button-text-color: var(--tg-theme-button-text-color, #fff);
            --bg: #f4f7f6; 
            --accent: #007bff;
        }

        body { 
            margin: 0; overflow: hidden; 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            display: flex; height: 100vh; 
            background: var(--bg); color: var(--tg-theme-text-color);
        }
        
        /* –°–ê–ô–î–ë–ê–† */
        #sidebar {
            width: 360px; background: var(--tg-theme-bg-color); 
            display: flex; flex-direction: column; z-index: 100; 
            box-shadow: 4px 0 20px rgba(0,0,0,0.05);
            height: 100%;
        }

        /* –í–ö–õ–ê–î–ö–ò */
        .tabs { display: flex; background: #eee; border-bottom: 1px solid #ddd; }
        .tab { 
            flex: 1; padding: 12px 5px; text-align: center; font-size: 12px; font-weight: 600; 
            color: #666; cursor: pointer; border-bottom: 3px solid transparent; 
        }
        .tab.active { border-bottom-color: var(--tg-theme-button-color); color: var(--tg-theme-button-color); background: #fff; }

        /* –ö–û–ù–¢–ï–ù–¢ –í–ö–õ–ê–î–û–ö */
        .tab-content { flex-grow: 1; overflow-y: auto; padding: 20px; display: none; }
        .tab-content.active { display: block; }

        /* –ó–ê–ì–õ–£–®–ö–ò */
        .dev-placeholder {
            text-align: center; color: #999; margin-top: 50px;
        }
        .dev-icon { font-size: 40px; margin-bottom: 10px; display: block; }

        /* –≠–õ–ï–ú–ï–ù–¢–´ –£–ü–†–ê–í–õ–ï–ù–ò–Ø */
        h3 { margin: 15px 0 8px; font-size: 13px; color: #888; text-transform: uppercase; font-weight: 700; }
        
        .system-select { width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; margin-bottom: 10px; }
        
        /* –°–õ–ê–ô–î–ï–† + –ò–ù–ü–£–¢ */
        .dim-control { 
            background: rgba(0,0,0,0.03); border-radius: 8px; padding: 10px; margin-bottom: 10px; 
        }
        .dim-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; }
        .dim-label { font-weight: 600; font-size: 14px; }
        .dim-input { 
            width: 60px; padding: 4px; border: 1px solid #ccc; border-radius: 4px; 
            text-align: center; font-size: 13px; font-weight: bold; color: var(--tg-theme-button-color);
        }
        input[type=range] { width: 100%; cursor: pointer; margin-top: 5px; }
        .dim-limits { display: flex; justify-content: space-between; font-size: 10px; color: #999; }

        /* –ú–ê–¢–ï–†–ò–ê–õ–´ –ò –¢–ï–ö–°–¢–£–†–´ */
        .mat-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px; margin-bottom: 10px; }
        .mat-item {
            aspect-ratio: 1; border-radius: 50%; cursor: pointer; border: 2px solid #ddd; position: relative;
            background-size: cover; background-position: center;
        }
        .mat-item.active { border-color: var(--tg-theme-button-color); transform: scale(1.15); box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        
        .texture-upload-btn {
            display: block; width: 100%; padding: 8px; text-align: center; border: 1px dashed #aaa; 
            border-radius: 6px; font-size: 12px; cursor: pointer; color: #555; margin-bottom: 15px;
        }
        .texture-upload-btn:hover { background: #f0f0f0; border-color: var(--tg-theme-button-color); }

        /* –ö–ù–û–ü–ö–ò –î–ï–ô–°–¢–í–ò–ô */
        .footer-actions { margin-top: 20px; display: grid; gap: 10px; }
        .btn {
            border: none; padding: 14px; border-radius: 10px; font-weight: 600; cursor: pointer;
            display: flex; justify-content: center; align-items: center; gap: 8px;
        }
        .btn-tg { background: var(--tg-theme-button-color); color: var(--tg-theme-button-text-color); }
        .btn-ar { background: #343a40; color: white; }
        .btn:disabled { opacity: 0.5; cursor: wait; }

        /* 3D –û–ö–ù–û */
        #canvas-container { flex-grow: 1; height: 100%; position: relative; background: radial-gradient(circle at center, #f8f9fa 0%, #eef2f5 100%); }
        
        #loader {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: rgba(255,255,255,0.9); padding: 15px 30px; border-radius: 50px;
            display: none; font-weight: bold; color: black; z-index: 1000; box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        @media (max-width: 768px) {
            body { flex-direction: column; }
            #canvas-container { height: 40vh; order: 1; }
            #sidebar { width: 100%; height: 60vh; order: 2; border-radius: 20px 20px 0 0; }
        }
        
        .drop-zone-container { display: none; }
        .drop-zone-container.active { display: block; }
        .toggle-custom { text-align: center; font-size: 12px; text-decoration: underline; color: #888; margin-bottom: 10px; cursor: pointer;}
    </style>

    <script type="importmap">
        { "imports": { "three": "https://unpkg.com/three@0.160.0/build/three.module.js", "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/" } }
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script type="module" src="https://ajax.googleapis.com/ajax/libs/model-viewer/3.4.0/model-viewer.min.js"></script>
</head>
<body>

<div id="sidebar">
    <div class="tabs">
        <div class="tab active" onclick="app.switchTab('config')">–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ç–æ—Ä</div>
        <div class="tab" onclick="app.switchTab('fill')">–ù–∞–ø–æ–ª–Ω–µ–Ω–∏–µ</div>
        <div class="tab" onclick="app.switchTab('services')">–£—Å–ª—É–≥–∏</div>
        <div class="tab" onclick="app.switchTab('cost')">–°–º–µ—Ç–∞</div>
    </div>

    <div id="tab-config" class="tab-content active">
        <h3>1. –ú–æ–¥–µ–ª—å</h3>
        <select id="preset-select" class="system-select" onchange="app.loadPreset()">
            <option value="" disabled selected>-- –í—ã–±–µ—Ä–∏—Ç–µ –∏–∑ —Å–ø–∏—Å–∫–∞ --</option>
        </select>
        
        <div class="toggle-custom" onclick="document.querySelector('.drop-zone-container').classList.toggle('active')">–ó–∞–≥—Ä—É–∑–∏—Ç—å —Å–≤–æ–π —Ñ–∞–π–ª...</div>
        <div class="drop-zone-container">
            <input type="file" id="input-obj" accept=".obj" style="margin-bottom:5px; width:100%">
            <input type="file" id="input-json" accept=".json" style="width:100%">
        </div>

        <h3>2. –†–∞–∑–º–µ—Ä—ã (–º–º)</h3>
        
        <div class="dim-control">
            <div class="dim-header">
                <span class="dim-label">–®–∏—Ä–∏–Ω–∞</span>
                <input type="number" id="num-w" class="dim-input" onchange="app.manualInput('w')">
            </div>
            <input type="range" id="range-w" disabled oninput="app.updateDimsFromSlider()">
            <div class="dim-limits"><span id="min-w">0</span><span id="max-w">0</span></div>
        </div>

        <div class="dim-control">
            <div class="dim-header">
                <span class="dim-label">–í—ã—Å–æ—Ç–∞</span>
                <input type="number" id="num-h" class="dim-input" onchange="app.manualInput('h')">
            </div>
            <input type="range" id="range-h" disabled oninput="app.updateDimsFromSlider()">
            <div class="dim-limits"><span id="min-h">0</span><span id="max-h">0</span></div>
        </div>

        <div class="dim-control">
            <div class="dim-header">
                <span class="dim-label">–ì–ª—É–±–∏–Ω–∞</span>
                <input type="number" id="num-d" class="dim-input" onchange="app.manualInput('d')">
            </div>
            <input type="range" id="range-d" disabled oninput="app.updateDimsFromSlider()">
            <div class="dim-limits"><span id="min-d">0</span><span id="max-d">0</span></div>
        </div>

        <h3>3. –û—Ç–¥–µ–ª–∫–∞</h3>
        
        <div style="font-size:12px; color:#888;">–ö–æ—Ä–ø—É—Å</div>
        <div class="mat-grid" id="mat-body"></div>
        <label class="texture-upload-btn">
            üñº –ó–∞–≥—Ä—É–∑–∏—Ç—å —Ç–µ–∫—Å—Ç—É—Ä—É –¥–ª—è –ö–æ—Ä–ø—É—Å–∞
            <input type="file" accept="image/*" style="display:none" onchange="app.uploadTexture('body', this)">
        </label>

        <div style="font-size:12px; color:#888; margin-top:5px;">–§–∞—Å–∞–¥—ã</div>
        <div class="mat-grid" id="mat-facade"></div>
        <label class="texture-upload-btn">
            üñº –ó–∞–≥—Ä—É–∑–∏—Ç—å —Ç–µ–∫—Å—Ç—É—Ä—É –¥–ª—è –§–∞—Å–∞–¥–∞
            <input type="file" accept="image/*" style="display:none" onchange="app.uploadTexture('facade', this)">
        </label>

        <div class="footer-actions">
            <button class="btn btn-tg" onclick="app.sendToTelegram()">üöÄ –û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞–∫–∞–∑ –≤ —á–∞—Ç</button>
            <button class="btn btn-ar" id="btn-ar" onclick="app.openAR()">üì± AR (–ü—Ä–∏–º–µ—Ä–∏—Ç—å)</button>
            <div style="text-align:center; font-size:10px; color:#aaa; cursor:pointer" onclick="app.exportArchive()">–°–∫–∞—á–∞—Ç—å ZIP (–ü–ö)</div>
        </div>
    </div>

    <div id="tab-fill" class="tab-content">
        <div class="dev-placeholder">
            <span class="dev-icon">üóÑ</span>
            <b>–†–∞–∑–¥–µ–ª "–ù–∞–ø–æ–ª–Ω–µ–Ω–∏–µ" –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ</b><br>
            –ó–¥–µ—Å—å –±—É–¥–µ—Ç –≤—ã–±–æ—Ä —è—â–∏–∫–æ–≤, –ø–æ–ª–æ–∫ –∏ —à—Ç–∞–Ω–≥.
        </div>
    </div>

    <div id="tab-services" class="tab-content">
        <div class="dev-placeholder">
            <span class="dev-icon">üõ†</span>
            <b>–†–∞–∑–¥–µ–ª "–£—Å–ª—É–≥–∏" –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ</b><br>
            –ó–¥–µ—Å—å –±—É–¥–µ—Ç –≤—ã–±–æ—Ä –¥–æ—Å—Ç–∞–≤–∫–∏ –∏ –º–æ–Ω—Ç–∞–∂–∞.
        </div>
    </div>

    <div id="tab-cost" class="tab-content">
        <div class="dev-placeholder">
            <span class="dev-icon">üí∞</span>
            <b>–†–∞–∑–¥–µ–ª "–°–º–µ—Ç–∞" –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ</b><br>
            –ó–¥–µ—Å—å –±—É–¥–µ—Ç —Ä–∞—Å—á–µ—Ç —Å—Ç–æ–∏–º–æ—Å—Ç–∏.
        </div>
    </div>
</div>

<div id="canvas-container">
    <div id="loader">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
    <model-viewer id="ar-viewer" ar ar-modes="webxr scene-viewer quick-look" camera-controls style="display: none;"></model-viewer>
</div>

<script type="module">
    import * as THREE from 'three';
    import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
    import { OBJLoader } from 'three/addons/loaders/OBJLoader.js';
    import { OBJExporter } from 'three/addons/exporters/OBJExporter.js';
    import { GLTFExporter } from 'three/addons/exporters/GLTFExporter.js';

    // TELEGRAM INIT
    const tg = window.Telegram.WebApp;
    tg.ready();
    tg.expand();

    // –ü–†–ï–°–ï–¢–´
    const PRESETS = {
        "salice_l70": {
            name: "Salice L70 Flex",
            url: "models/salice_l70.obj",
            limits: { minW: 1740, maxW: 3400, minH: 1800, maxH: 2700, minD: 400, maxD: 900 },
            defaults: { w: 2400, h: 2600, d: 650 }
        },
        "salice_m50": {
            name: "Salice M50 Flex",
            url: "models/salice_m50.obj",
            limits: { minW: 2340, maxW: 3200, minH: 1800, maxH: 2700, minD: 400, maxD: 900 },
            defaults: { w: 2800, h: 2600, d: 650 }
        },
        "hettich_tl": {
            name: "Hettich TopLine XL",
            url: "models/hettich_tl.obj",
            limits: { minW: 1200, maxW: 4000, minH: 2000, maxH: 3000, minD: 500, maxD: 800 },
            defaults: { w: 2000, h: 2400, d: 600 }
        },
        "wingline": {
            name: "Hettich WingLine L",
            url: "models/wingline.obj",
            limits: { minW: 500, maxW: 2400, minH: 1000, maxH: 2600, minD: 350, maxD: 700 },
            defaults: { w: 1200, h: 2200, d: 550 }
        }
    };

    let currentModel = null;
    let baseDims = { w: 1, h: 1, d: 1 };
    let currentConfig = { name: "Custom", w: 1000, h: 1000, d: 600 };
    
    // –ë–ê–ó–û–í–´–ï –ú–ê–¢–ï–†–ò–ê–õ–´
    const MATERIALS = [
        { name: "–ë–µ–ª—ã–π", color: "#f7f7f7" },
        { name: "–°–µ—Ä—ã–π", color: "#8c8c8c" },
        { name: "–ì—Ä–∞—Ñ–∏—Ç", color: "#333333" },
        { name: "–ö–∞—à–µ–º–∏—Ä", color: "#d1c7b6" },
        { name: "–î—É–±", color: "#8b5a2b" }
    ];
    let selBody = { type: 'color', val: MATERIALS[0] };
    let selFacade = { type: 'color', val: MATERIALS[0] };
    
    // –¢–ï–ö–°–¢–£–†–ù–´–ô –ó–ê–ì–†–£–ó–ß–ò–ö
    const textureLoader = new THREE.TextureLoader();

    // SCENE
    const scene = new THREE.Scene();
    const container = document.getElementById('canvas-container');
    const camera = new THREE.PerspectiveCamera(45, container.clientWidth / container.clientHeight, 100, 20000);
    camera.position.set(2500, 1800, 3500);

    const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true, preserveDrawingBuffer: true });
    renderer.setSize(container.clientWidth, container.clientHeight);
    renderer.shadowMap.enabled = true;
    container.appendChild(renderer.domElement);

    const controls = new OrbitControls(camera, renderer.domElement);
    controls.enableDamping = true;
    controls.maxPolarAngle = Math.PI / 2 - 0.05;

    const hemiLight = new THREE.HemisphereLight(0xffffff, 0xebf4fa, 0.6);
    scene.add(hemiLight);
    const dirLight = new THREE.DirectionalLight(0xffffff, 0.8);
    dirLight.position.set(1500, 3000, 2000);
    dirLight.castShadow = true;
    scene.add(dirLight);
    const shadowPlane = new THREE.Mesh(new THREE.PlaneGeometry(10000, 10000), new THREE.ShadowMaterial({ opacity: 0.1 }));
    shadowPlane.rotation.x = -Math.PI / 2;
    shadowPlane.receiveShadow = true;
    scene.add(shadowPlane);

    // APP LOGIC
    const app = {
        init: () => {
            const select = document.getElementById('preset-select');
            for (const [key, val] of Object.entries(PRESETS)) {
                const opt = document.createElement('option');
                opt.value = key; opt.innerText = val.name; select.appendChild(opt);
            }
            app.renderPalette('mat-body', 'body');
            app.renderPalette('mat-facade', 'facade');
            if (tg.colorScheme === 'dark') document.documentElement.style.setProperty('--bg', '#1c1c1e');
        },

        // --- –í–ö–õ–ê–î–ö–ò ---
        switchTab: (tabName) => {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            
            // –ù–∞—Ö–æ–¥–∏–º –∏–Ω–¥–µ–∫—Å –≤–∫–ª–∞–¥–∫–∏
            const tabs = ['config', 'fill', 'services', 'cost'];
            document.querySelectorAll('.tab')[tabs.indexOf(tabName)].classList.add('active');
            document.getElementById('tab-'+tabName).classList.add('active');
        },

        // --- –ó–ê–ì–†–£–ó–ö–ê ---
        loadPreset: () => {
            const key = document.getElementById('preset-select').value;
            const preset = PRESETS[key];
            if (!preset) return;
            app.setupSlider('w', preset.limits.minW, preset.limits.maxW, preset.defaults.w);
            app.setupSlider('h', preset.limits.minH, preset.limits.maxH, preset.defaults.h);
            app.setupSlider('d', preset.limits.minD, preset.limits.maxD, preset.defaults.d);
            currentConfig.name = preset.name;
            app.loadOBJ(preset.url, true);
        },

        loadOBJ: (url, isPreset = false) => {
            document.getElementById('loader').style.display = 'block';
            document.getElementById('loader').innerText = "–ó–∞–≥—Ä—É–∑–∫–∞ 3D...";
            
            if (currentModel) scene.remove(currentModel);
            new OBJLoader().load(url, (obj) => {
                currentModel = obj;
                scene.add(obj);
                const box = new THREE.Box3().setFromObject(obj);
                const size = box.getSize(new THREE.Vector3());
                baseDims = { w: size.x, h: size.y, d: size.z };
                const center = box.getCenter(new THREE.Vector3());
                obj.position.x = -center.x; obj.position.y = -box.min.y; obj.position.z = -center.z;
                app.applyMaterials();
                app.updateDimsFromSlider(); 
                document.getElementById('loader').style.display = 'none';
                if (!isPreset) alert("–ú–æ–¥–µ–ª—å –∑–∞–≥—Ä—É–∂–µ–Ω–∞.");
            }, undefined, (err) => {
                alert("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: " + url);
                document.getElementById('loader').style.display = 'none';
            });
        },

        loadJSON: (text) => {
            try {
                const data = JSON.parse(text);
                const l = data.limits || {}; const d = data.dimensions || {};
                app.setupSlider('w', l.minW||500, l.maxW||3000, d.w||1000);
                app.setupSlider('h', l.minH||1000, l.maxH||3000, d.h||2000);
                app.setupSlider('d', l.minD||300, l.maxD||1000, d.d||600);
                currentConfig.name = data.name || "Custom";
                app.updateDimsFromSlider();
                alert("–ù–∞—Å—Ç—Ä–æ–π–∫–∏ JSON –ø—Ä–∏–º–µ–Ω–µ–Ω—ã!");
            } catch (e) { alert("–û—à–∏–±–∫–∞ JSON"); }
        },

        // --- –£–ü–†–ê–í–õ–ï–ù–ò–ï –†–ê–ó–ú–ï–†–ê–ú–ò (–°–ª–∞–π–¥–µ—Ä + –ò–Ω–ø—É—Ç) ---
        setupSlider: (axis, min, max, val) => {
            const slider = document.getElementById('range-'+axis);
            const input = document.getElementById('num-'+axis);
            
            slider.min = min; slider.max = max; slider.value = val; slider.disabled = false;
            input.min = min; input.max = max; input.value = val;
            
            document.getElementById('min-'+axis).innerText = min;
            document.getElementById('max-'+axis).innerText = max;
        },

        // –î–≤–∏–∂–µ–Ω–∏–µ –ø–æ–ª–∑—É–Ω–∫–∞
        updateDimsFromSlider: () => {
            ['w', 'h', 'd'].forEach(axis => {
                const val = document.getElementById('range-'+axis).value;
                document.getElementById('num-'+axis).value = val;
            });
            app.applyScale();
        },

        // –†—É—á–Ω–æ–π –≤–≤–æ–¥ —Ü–∏—Ñ—Ä
        manualInput: (axis) => {
            const input = document.getElementById('num-'+axis);
            const slider = document.getElementById('range-'+axis);
            let val = parseInt(input.value);
            
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–∏–º–∏—Ç–æ–≤
            if (val < slider.min) val = slider.min;
            if (val > slider.max) val = slider.max;
            
            input.value = val;
            slider.value = val;
            app.applyScale();
        },

        applyScale: () => {
            const w = document.getElementById('range-w').value;
            const h = document.getElementById('range-h').value;
            const d = document.getElementById('range-d').value;
            
            if (currentModel) currentModel.scale.set(w / baseDims.w, h / baseDims.h, d / baseDims.d);
            currentConfig.w = w; currentConfig.h = h; currentConfig.d = d;
        },

        // --- –ú–ê–¢–ï–†–ò–ê–õ–´ –ò –¢–ï–ö–°–¢–£–†–´ ---
        renderPalette: (containerId, type) => {
            const container = document.getElementById(containerId);
            MATERIALS.forEach((m, idx) => {
                const btn = document.createElement('div');
                btn.className = `mat-item ${idx===0 ? 'active' : ''}`;
                btn.style.backgroundColor = m.color;
                btn.onclick = () => {
                    container.querySelectorAll('.mat-item').forEach(b => {
                        b.classList.remove('active');
                        b.style.backgroundImage = 'none';
                    });
                    btn.classList.add('active');
                    
                    if(type==='body') selBody = { type: 'color', val: m }; 
                    else selFacade = { type: 'color', val: m };
                    
                    app.applyMaterials();
                };
                container.appendChild(btn);
            });
        },

        // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–≤–æ–µ–π –∫–∞—Ä—Ç–∏–Ω–∫–∏
        uploadTexture: (type, input) => {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    // –°–æ–∑–¥–∞–µ–º —Ç–µ–∫—Å—Ç—É—Ä—É
                    const tex = textureLoader.load(e.target.result);
                    tex.wrapS = THREE.RepeatWrapping;
                    tex.wrapT = THREE.RepeatWrapping;
                    
                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—ã–±–æ—Ä
                    const selection = { type: 'texture', val: tex, name: '–°–≤–æ—è —Ç–µ–∫—Å—Ç—É—Ä–∞' };
                    if (type === 'body') selBody = selection;
                    else selFacade = selection;

                    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ —Ü–≤–µ—Ç–æ–≤
                    const container = document.getElementById(type === 'body' ? 'mat-body' : 'mat-facade');
                    container.querySelectorAll('.mat-item').forEach(b => b.classList.remove('active'));

                    app.applyMaterials();
                };
                reader.readAsDataURL(input.files[0]);
            }
        },

        applyMaterials: () => {
            if(!currentModel) return;

            const getMat = (selection) => {
                if (selection.type === 'color') {
                    return new THREE.MeshStandardMaterial({ color: selection.val.color, roughness: 0.7 });
                } else {
                    return new THREE.MeshStandardMaterial({ map: selection.val, roughness: 0.7 });
                }
            };

            const mBody = getMat(selBody);
            const mFacade = getMat(selFacade);

            currentModel.traverse(child => {
                if(child.isMesh) {
                    const n = child.name.toLowerCase();
                    if(n.includes('facade') || n.includes('door') || n.includes('front') || n.includes('glass') || n.includes('—Ñ–∞—Å–∞–¥') || n.includes('–¥–≤–µ—Ä—å')) {
                        child.material = mFacade;
                    } else {
                        child.material = mBody;
                    }
                }
            });
        },

        // --- AR (–£–õ–£–ß–®–ï–ù–ù–´–ô) ---
        openAR: () => {
            if(!currentModel) return tg.showAlert("–°–Ω–∞—á–∞–ª–∞ –∑–∞–≥—Ä—É–∑–∏—Ç–µ –º–æ–¥–µ–ª—å!");
            
            const btn = document.getElementById('btn-ar');
            const loader = document.getElementById('loader');
            
            btn.disabled = true;
            btn.innerText = "‚è≥ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è AR...";
            loader.style.display = 'block';
            loader.innerText = "–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ AR...";

            const exporter = new GLTFExporter();
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º binary: true –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è .glb (–ª—É—á—à–µ –¥–ª—è Android)
            exporter.parse(currentModel, (gltf) => {
                const blob = new Blob([gltf], { type: 'model/gltf-binary' });
                const url = URL.createObjectURL(blob);
                
                const viewer = document.getElementById('ar-viewer');
                viewer.src = url;
                
                // –ü—ã—Ç–∞–µ–º—Å—è –∑–∞–ø—É—Å—Ç–∏—Ç—å AR
                try {
                    viewer.activateAR();
                } catch(e) {
                    alert("–í–∞—à–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –º–æ–∂–µ—Ç –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—Ç—å WebAR. " + e);
                }

                // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –∫–Ω–æ–ø–∫–∏
                loader.style.display = 'none';
                btn.disabled = false;
                btn.innerText = "üì± AR (–ü—Ä–∏–º–µ—Ä–∏—Ç—å)";
                
            }, (e) => {
                alert("–û—à–∏–±–∫–∞ AR —ç–∫—Å–ø–æ—Ä—Ç–∞: " + e);
                loader.style.display = 'none';
                btn.disabled = false;
                btn.innerText = "üì± AR (–ü—Ä–∏–º–µ—Ä–∏—Ç—å)";
            }, { binary: true });
        },

        sendToTelegram: () => {
            if(!currentModel) return tg.showAlert("–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ —à–∫–∞—Ñ!");
            
            const getName = (sel) => sel.type === 'color' ? sel.val.name : '–°–≤–æ—è —Ç–µ–∫—Å—Ç—É—Ä–∞';

            const orderData = {
                model: currentConfig.name,
                size: `${currentConfig.w} x ${currentConfig.h} x ${currentConfig.d}`,
                body: getName(selBody),
                facade: getName(selFacade),
                date: new Date().toLocaleDateString()
            };

            try {
                tg.sendData(JSON.stringify(orderData));
            } catch (e) {
                alert("–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏: " + e.message);
            }
        },

        exportArchive: () => {
            if(!currentModel) return alert("–ù–µ—Ç –º–æ–¥–µ–ª–∏!");
            const zip = new JSZip();
            const fileName = `${currentConfig.name}_${currentConfig.w}x${currentConfig.h}`;
            
            const getName = (sel) => sel.type === 'color' ? sel.val.name : 'Custom Texture';
            
            const orderJson = {
                Model: currentConfig.name,
                Dimensions: { Width: currentConfig.w, Height: currentConfig.h, Depth: currentConfig.d },
                Materials: { Body: getName(selBody), Facade: getName(selFacade) }
            };
            zip.file("order_params.json", JSON.stringify(orderJson, null, 2));
            const exporter = new OBJExporter();
            zip.file("visual_model.obj", exporter.parse(currentModel));
            zip.generateAsync({type:"blob"}).then(c => saveAs(c, fileName+".zip"));
        }
    };

    window.app = app;
    app.init();

    // LISTENERS
    document.getElementById('input-obj').addEventListener('change', (e) => {
        if(e.target.files[0]) app.loadOBJ(URL.createObjectURL(e.target.files[0]));
    });
    document.getElementById('input-json').addEventListener('change', (e) => {
        if(e.target.files[0]) {
            const r = new FileReader();
            r.onload = (evt) => app.loadJSON(evt.target.result);
            r.readAsText(e.target.files[0]);
        }
    });

    function animate() { requestAnimationFrame(animate); controls.update(); renderer.render(scene, camera); }
    animate();
    window.addEventListener('resize', () => { camera.aspect = container.clientWidth/container.clientHeight; camera.updateProjectionMatrix(); renderer.setSize(container.clientWidth, container.clientHeight); });
</script>
</body>
</html>