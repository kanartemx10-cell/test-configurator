
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Infinity Configurator</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        body { margin: 0; font-family: 'Montserrat', sans-serif; background: #0f1115; color: white; overflow: hidden; }
        #ui-container { position: absolute; bottom: 0; left: 0; width: 100%; background: rgba(20, 22, 28, 0.95); border-top: 1px solid #333; padding: 20px; box-sizing: border-box; border-radius: 20px 20px 0 0; max-height: 50vh; overflow-y: auto; z-index: 100; }
        .price-tag { position: absolute; top: 20px; right: 20px; background: rgba(0, 212, 255, 0.15); color: #00d4ff; padding: 8px 15px; border-radius: 30px; border: 1px solid #00d4ff; font-size: 18px; font-weight: 800; z-index: 50; }
        h2 { margin: 0 0 15px 0; font-size: 14px; color: #888; text-transform: uppercase; }
        .control-row { display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px; }
        .label { font-size: 13px; color: #aaa; width: 60px; }
        .val { font-weight: bold; width: 45px; text-align: right; color: #fff; font-size: 13px; }
        input[type=range] { flex-grow: 1; margin: 0 10px; accent-color: #00d4ff; }
        .mat-grid { display: flex; gap: 10px; overflow-x: auto; padding-bottom: 10px; margin-bottom: 20px; }
        .mat-card { min-width: 70px; height: 70px; background: #222; border-radius: 12px; border: 2px solid #333; cursor: pointer; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .mat-card.active { border-color: #00d4ff; background: #2a2a2a; }
        .mat-color { width: 25px; height: 25px; border-radius: 50%; margin-bottom: 5px; }
        .mat-name { font-size: 9px; color: #aaa; text-align: center; }
        #canvas-3d { width: 100%; height: 100vh; position: absolute; top: 0; left: 0; }
        @media(min-width: 768px) { #ui-container { width: 400px; height: 100vh; top: 0; right: 0; border-radius: 0; max-height: 100vh; border-left: 1px solid #333; border-top: none; } #canvas-3d { width: calc(100% - 400px); } }
    </style>
</head>
<body>
<div id="canvas-3d"></div>
<div class="price-tag"><span id="total-price">0</span> сум</div>
<div id="ui-container">
    <h2>Размеры</h2>
    <div class="control-row"><span class="label">Шир</span><input type="range" id="w" oninput="updateAll()"><span class="val" id="val_w"></span></div>
    <div class="control-row"><span class="label">Выс</span><input type="range" id="h" oninput="updateAll()"><span class="val" id="val_h"></span></div>
    <div class="control-row"><span class="label">Глуб</span><input type="range" id="d" oninput="updateAll()"><span class="val" id="val_d"></span></div>
    <h2>Декор</h2>
    <div class="mat-grid" id="mat-list"></div>
    <div style="height: 20px;"></div> </div>
<script>
    const tg = window.Telegram.WebApp;
    tg.expand();
    
    // ДАННЫЕ
    const limits = {"min_width":300,"max_width":3900,"min_height":400,"max_height":3726,"min_depth":300,"max_depth":1000};
    const dimensions = {"width":3400,"height":3226,"depth":1800};
    const materials = [{"name":"ЛДСП Белый базовый 16мм","label":"Белый Базовый","color":15395562,"price":5000},{"name":"ЛДСП Эггер Дуб Галифакс натуральный","label":"Дуб Галифакс","color":9132587,"price":12000},{"name":"ЛДСП Серый графит U999","label":"Графит","color":3355443,"price":8500},{"name":"МДФ Белый глянец","label":"Белый Глянец","color":16777215,"price":15000}];

    // 3D
    const scene = new THREE.Scene(); scene.background = new THREE.Color(0x0f1115);
    const camera = new THREE.PerspectiveCamera(45, window.innerWidth/window.innerHeight, 1, 10000);
    camera.position.set(3500, 2000, 3500); camera.lookAt(0, 1000, 0);
    const renderer = new THREE.WebGLRenderer({ antialias: true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    document.getElementById('canvas-3d').appendChild(renderer.domElement);
    scene.add(new THREE.HemisphereLight(0xffffff, 0x444444, 0.8));
    const dirLight = new THREE.DirectionalLight(0xffffff, 0.8);
    dirLight.position.set(1000, 3000, 2000); scene.add(dirLight);
    const geometry = new THREE.BoxGeometry(1, 1, 1); geometry.translate(0, 0.5, 0);
    const material3D = new THREE.MeshPhongMaterial({ color: 0xeaeaea, specular: 0x111111, shininess: 30 });
    const cube = new THREE.Mesh(geometry, material3D); scene.add(cube);
    scene.add(new THREE.GridHelper(5000, 50, 0x333333, 0x1a1a1a));

    const inpW = document.getElementById('w'); const inpH = document.getElementById('h'); const inpD = document.getElementById('d');
    inpW.min = limits.min_width; inpW.max = limits.max_width; inpW.value = dimensions.width;
    inpH.min = limits.min_height; inpH.max = limits.max_height; inpH.value = dimensions.height;
    inpD.min = limits.min_depth; inpD.max = limits.max_depth; inpD.value = dimensions.depth;

    let selectedMatIndex = 0;
    const matList = document.getElementById('mat-list');
    materials.forEach((mat, index) => {
        const div = document.createElement('div');
        div.className = 'mat-card' + (index === 0 ? ' active' : '');
        div.innerHTML = `<div class="mat-color" style="background-color: #${mat.color.toString(16)}"></div><div class="mat-name">${mat.label}</div>`;
        div.onclick = () => {
            selectedMatIndex = index;
            document.querySelectorAll('.mat-card').forEach(c => c.classList.remove('active'));
            div.classList.add('active');
            material3D.color.setHex(materials[index].color);
            updateAll();
        };
        matList.appendChild(div);
    });

    function updateAll() {
        const w = parseInt(inpW.value); const h = parseInt(inpH.value); const d = parseInt(inpD.value);
        document.getElementById('val_w').innerText = w; document.getElementById('val_h').innerText = h; document.getElementById('val_d').innerText = d;
        cube.scale.set(w, h, d);
        renderer.render(scene, camera);
        const area = ((w*h*2) + (w*d*2) + (h*d*2)) / 1000000;
        const total = Math.round(area * 1.3 * materials[selectedMatIndex].price);
        document.getElementById('total-price').innerText = total.toLocaleString('ru-RU');
        
        // КНОПКА TELEGRAM (MAIN BUTTON)
        if (!tg.MainButton.isVisible) {
            tg.MainButton.setText("ОФОРМИТЬ ЗАКАЗ");
            tg.MainButton.show();
        }
    }
    
    // ВАЖНО: Привязываем событие напрямую к MainButton
    tg.MainButton.onClick(function() {
        const orderData = {
            name: "Model",
            dimensions: { width: parseInt(inpW.value), height: parseInt(inpH.value), depth: parseInt(inpD.value) },
            target_material: materials[selectedMatIndex].name
        };
        tg.sendData(JSON.stringify(orderData)); 
    });

    let isDown=false, startX; const cvs = document.getElementById('canvas-3d');
    cvs.addEventListener('mousedown', e=>{isDown=true; startX=e.clientX;}); window.addEventListener('mouseup',()=>isDown=false);
    window.addEventListener('mousemove',e=>{if(!isDown)return; const d=(e.clientX-startX)*0.005; camera.position.x=camera.position.x*Math.cos(d)-camera.position.z*Math.sin(d); camera.position.z=camera.position.x*Math.sin(d)+camera.position.z*Math.cos(d); camera.lookAt(0,1000,0); startX=e.clientX; renderer.render(scene, camera);});
    window.addEventListener('resize', ()=>{renderer.setSize(window.innerWidth, window.innerHeight); camera.aspect=window.innerWidth/window.innerHeight; camera.updateProjectionMatrix(); renderer.render(scene, camera);});

    updateAll();
</script>
</body>
</html>
