
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Infinity Configurator V9</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        /* CSS STYLES */
        body { margin: 0; font-family: 'Montserrat', sans-serif; background: #0f1115; color: white; overflow: hidden; }
        #canvas-3d { width: 100%; height: 65vh; position: absolute; top: 0; left: 0; }
        
        #ui-container {
            position: absolute; bottom: 0; left: 0; width: 100%; height: 35vh;
            background: rgba(25, 27, 33, 0.98); border-top: 1px solid #333;
            box-shadow: 0 -5px 20px rgba(0,0,0,0.5);
            display: flex; flex-direction: column;
        }

        /* TABS */
        .tabs-header { display: flex; border-bottom: 1px solid #333; background: #111; }
        .tab-btn { flex: 1; padding: 15px 0; text-align: center; color: #888; cursor: pointer; font-weight: 600; font-size: 12px; text-transform: uppercase; transition: 0.2s; }
        .tab-btn.active { color: #00d4ff; border-bottom: 2px solid #00d4ff; background: rgba(0, 212, 255, 0.05); }
        .tab-content { padding: 20px; overflow-y: auto; flex-grow: 1; display: none; }
        .tab-content.active { display: block; }

        /* CONTROLS */
        h3 { margin: 0 0 10px 0; font-size: 12px; color: #666; text-transform: uppercase; }
        .control-row { display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px; }
        .label { font-size: 13px; color: #aaa; width: 50px; }
        .val { font-weight: bold; width: 45px; text-align: right; color: #fff; font-size: 13px; }
        input[type=range] { flex-grow: 1; margin: 0 15px; accent-color: #00d4ff; }
        
        /* MAT GRIDS */
        .mat-grid { display: flex; gap: 10px; overflow-x: auto; padding-bottom: 10px; margin-bottom: 15px; }
        .mat-card { min-width: 60px; height: 60px; background: #222; border-radius: 10px; border: 1px solid #333; cursor: pointer; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .mat-card.active { border-color: #00d4ff; background: #2a2a2a; }
        .mat-color { width: 20px; height: 20px; border-radius: 50%; margin-bottom: 5px; box-shadow: inset 0 0 2px rgba(0,0,0,0.5); }
        .mat-name { font-size: 8px; color: #aaa; text-align: center; }

        /* DROPDOWNS */
        select { width: 100%; padding: 12px; background: #222; border: 1px solid #333; color: white; border-radius: 8px; margin-bottom: 15px; outline: none; font-family: inherit; }

        .price-tag { position: absolute; top: 20px; right: 20px; background: rgba(0,0,0,0.5); color: #00d4ff; padding: 8px 15px; border-radius: 30px; border: 1px solid #00d4ff; font-size: 16px; font-weight: 800; z-index: 50; backdrop-filter: blur(5px); }

        @media(min-width: 768px) { 
            #canvas-3d { width: 60%; height: 100vh; }
            #ui-container { width: 40%; height: 100vh; top: 0; right: 0; border-top: none; border-left: 1px solid #333; }
            .tab-btn { padding: 20px 0; }
        }
    </style>
</head>
<body>

<div id="canvas-3d"></div>
<div class="price-tag"><span id="total-price">0</span> —Å—É–º</div>

<div id="ui-container">
    <div class="tabs-header">
        <div class="tab-btn active" onclick="switchTab(0)">üìè –†–∞–∑–º–µ—Ä—ã</div>
        <div class="tab-btn" onclick="switchTab(1)">üé® –î–∏–∑–∞–π–Ω</div>
        <div class="tab-btn" onclick="switchTab(2)">üì¶ –ù–∞–ø–æ–ª–Ω–µ–Ω–∏–µ</div>
    </div>

    <div class="tab-content active">
        <div class="control-row"><span class="label">–®–∏—Ä</span><input type="range" id="w" oninput="updateAll()"><span class="val" id="val_w"></span></div>
        <div class="control-row"><span class="label">–í—ã—Å</span><input type="range" id="h" oninput="updateAll()"><span class="val" id="val_h"></span></div>
        <div class="control-row"><span class="label">–ì–ª—É–±</span><input type="range" id="d" oninput="updateAll()"><span class="val" id="val_d"></span></div>
    </div>

    <div class="tab-content">
        <h3>–ö–æ—Ä–ø—É—Å</h3>
        <div class="mat-grid" id="carcass-list"></div>
        <h3>–§–∞—Å–∞–¥—ã</h3>
        <div class="mat-grid" id="facade-list"></div>
    </div>

    <div class="tab-content">
        <h3>–°–µ–∫—Ü–∏—è 1 (–õ–µ–≤–∞—è)</h3>
        <select id="fill1"></select>
        <h3>–°–µ–∫—Ü–∏—è 2 (–ü—Ä–∞–≤–∞—è)</h3>
        <select id="fill2"></select>
    </div>
</div>

<script>
    const tg = window.Telegram.WebApp; tg.expand();
    const data = {
        limits: {"min_width":300,"max_width":3900,"min_height":400,"max_height":3000,"min_depth":300,"max_depth":1000},
        dims: {"width":3400,"height":2960,"depth":1026},
        carcassDB: [{"name":"–õ–î–°–ü –ë–µ–ª—ã–π –±–∞–∑–æ–≤—ã–π 16–º–º","label":"–ë–µ–ª—ã–π","color":15395562,"price":5000},{"name":"–õ–î–°–ü –°–µ—Ä—ã–π –≥—Ä–∞—Ñ–∏—Ç U999","label":"–ì—Ä–∞—Ñ–∏—Ç","color":3355443,"price":8500},{"name":"–õ–î–°–ü –î—É–± –°–æ–Ω–æ–º–∞","label":"–î—É–± –°–æ–Ω–æ–º–∞","color":10716778,"price":9000}],
        facadeDB: [{"name":"–ú–î–§ –ë–µ–ª—ã–π –≥–ª—è–Ω–µ—Ü","label":"–ë–µ–ª—ã–π –ì–ª—è–Ω–µ—Ü","color":16777215,"price":15000,"glossy":true},{"name":"–õ–î–°–ü –≠–≥–≥–µ—Ä –î—É–± –ì–∞–ª–∏—Ñ–∞–∫—Å","label":"–î—É–± –ì–∞–ª–∏—Ñ–∞–∫—Å","color":9132587,"price":12000,"glossy":false},{"name":"–ú–î–§ –°–µ—Ä—ã–π –º–∞—Ç–æ–≤—ã–π","label":"–°–µ—Ä—ã–π –ú–∞—Ç","color":4473924,"price":14000,"glossy":false}],
        fillingOpts: ["–ü–æ–ª–∫–∏","–®—Ç–∞–Ω–≥–∞","–Ø—â–∏–∫–∏ + –ü–æ–ª–∫–∏","–ü—É—Å—Ç–æ"],
        defaultFill: {"section1":"–ü–æ–ª–∫–∏","section2":"–®—Ç–∞–Ω–≥–∞"}
    };

    let state = {
        w: data.dims.width, h: data.dims.height, d: data.dims.depth,
        carcassIdx: 0, facadeIdx: 0
    };

    // === 3D SETUP ===
    const scene = new THREE.Scene(); scene.background = new THREE.Color(0x0f1115);
    const camera = new THREE.PerspectiveCamera(45, window.innerWidth/(window.innerHeight*0.65), 1, 10000);
    camera.position.set(3500, 2000, 3500); camera.lookAt(0, 1000, 0);
    const renderer = new THREE.WebGLRenderer({ antialias: true });
    renderer.setSize(document.getElementById('canvas-3d').clientWidth, document.getElementById('canvas-3d').clientHeight);
    document.getElementById('canvas-3d').appendChild(renderer.domElement);
    
    scene.add(new THREE.HemisphereLight(0xffffff, 0x444444, 0.8));
    const dirLight = new THREE.DirectionalLight(0xffffff, 0.5); dirLight.position.set(1000, 3000, 2000); scene.add(dirLight);
    const spotLight = new THREE.SpotLight(0xffffff, 0.5); spotLight.position.set(2000, 4000, 2000); scene.add(spotLight);

    // --- –°–û–ó–î–ê–ù–ò–ï –ú–û–î–ï–õ–ò (–ö–û–†–ü–£–° + –§–ê–°–ê–î) ---
    const FACADE_THICKNESS = 20; // –¢–æ–ª—â–∏–Ω–∞ —Ñ–∞—Å–∞–¥–∞ –¥–ª—è –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏

    // –ú–∞—Ç–µ—Ä–∏–∞–ª—ã
    const matCarcass = new THREE.MeshPhongMaterial({ color: data.carcassDB[0].color });
    const matFacade = new THREE.MeshStandardMaterial({ color: data.facadeDB[0].color, roughness: 0.5, metalness: 0.1 });

    // –ì–µ–æ–º–µ—Ç—Ä–∏—è –ö–æ—Ä–ø—É—Å–∞ (–ó–∞–¥–Ω—è—è —á–∞—Å—Ç—å)
    const geoCarcass = new THREE.BoxGeometry(1, 1, 1); geoCarcass.translate(0, 0.5, -0.5); // –°–¥–≤–∏–≥: —Å—Ç–æ–∏—Ç –Ω–∞ –ø–æ–ª—É, —Ü–µ–Ω—Ç—Ä —Å–∑–∞–¥–∏
    const carcassMesh = new THREE.Mesh(geoCarcass, matCarcass);
    scene.add(carcassMesh);

    // –ì–µ–æ–º–µ—Ç—Ä–∏—è –§–∞—Å–∞–¥–∞ (–ü–µ—Ä–µ–¥–Ω—è—è –ø–∞–Ω–µ–ª—å)
    const geoFacade = new THREE.BoxGeometry(1, 1, 1); geoFacade.translate(0, 0.5, 0.5); // –°–¥–≤–∏–≥: —Å—Ç–æ–∏—Ç –Ω–∞ –ø–æ–ª—É, —Ü–µ–Ω—Ç—Ä —Å–ø–µ—Ä–µ–¥–∏
    const facadeMesh = new THREE.Mesh(geoFacade, matFacade);
    scene.add(facadeMesh);

    scene.add(new THREE.GridHelper(5000, 50, 0x333333, 0x1a1a1a));

    // === UI SETUP ===
    // Tabs logic
    const tabs = document.querySelectorAll('.tab-btn');
    const contents = document.querySelectorAll('.tab-content');
    window.switchTab = (idx) => {
        tabs.forEach((t, i) => t.classList.toggle('active', i === idx));
        contents.forEach((c, i) => c.classList.toggle('active', i === idx));
    };

    // Sliders
    const inpW = document.getElementById('w'); inpW.min=data.limits.min_width; inpW.max=data.limits.max_width; inpW.value=state.w;
    const inpH = document.getElementById('h'); inpH.min=data.limits.min_height; inpH.max=data.limits.max_height; inpH.value=state.h;
    const inpD = document.getElementById('d'); inpD.min=data.limits.min_depth; inpD.max=data.limits.max_depth; inpD.value=state.d;

    // Material Builders
    function buildMatGrid(db, containerId, onClick) {
        const cont = document.getElementById(containerId);
        db.forEach((mat, idx) => {
            const div = document.createElement('div'); div.className = 'mat-card' + (idx===0?' active':'');
            div.innerHTML = `<div class="mat-color" style="background-color: #${mat.color.toString(16)}"></div><div class="mat-name">${mat.label}</div>`;
            div.onclick = () => { 
                cont.querySelectorAll('.mat-card').forEach(c=>c.classList.remove('active')); div.classList.add('active');
                onClick(idx);
            };
            cont.appendChild(div);
        });
    }
    buildMatGrid(data.carcassDB, 'carcass-list', (idx) => { state.carcassIdx = idx; updateAll(); });
    buildMatGrid(data.facadeDB, 'facade-list', (idx) => { state.facadeIdx = idx; updateAll(); });

    // Filling Dropdowns
    const fill1 = document.getElementById('fill1');
    const fill2 = document.getElementById('fill2');
    data.fillingOpts.forEach(opt => {
        fill1.add(new Option(opt, opt)); fill2.add(new Option(opt, opt));
    });
    fill1.value = data.defaultFill.section1; fill2.value = data.defaultFill.section2;


    // === UPDATE LOOP ===
    function updateAll() {
        state.w = parseInt(inpW.value); state.h = parseInt(inpH.value); state.d = parseInt(inpD.value);
        document.getElementById('val_w').innerText = state.w; document.getElementById('val_h').innerText = state.h; document.getElementById('val_d').innerText = state.d;

        // UPDATE 3D MODEL
        // –ö–æ—Ä–ø—É—Å: –ì–ª—É–±–∏–Ω–∞ = –û–±—â–∞—è –≥–ª—É–±–∏–Ω–∞ - –¢–æ–ª—â–∏–Ω–∞ —Ñ–∞—Å–∞–¥–∞
        const carcassDepth = state.d - FACADE_THICKNESS;
        carcassMesh.scale.set(state.w, state.h, carcassDepth);
        // –ü–æ–∑–∏—Ü–∏—è –∫–æ—Ä–ø—É—Å–∞: –æ—Ç–æ–¥–≤–∏–≥–∞–µ–º –Ω–∞–∑–∞–¥ –Ω–∞ —Ç–æ–ª—â–∏–Ω—É —Ñ–∞—Å–∞–¥–∞
        carcassMesh.position.z = -FACADE_THICKNESS;

        // –§–∞—Å–∞–¥: –¢–æ–Ω–∫–∏–π, –ø–æ–ª–Ω–∞—è —à–∏—Ä–∏–Ω–∞ –∏ –≤—ã—Å–æ—Ç–∞
        facadeMesh.scale.set(state.w, state.h, FACADE_THICKNESS);
        facadeMesh.position.z = 0;

        // Colors & Materials
        matCarcass.color.setHex(data.carcassDB[state.carcassIdx].color);
        matFacade.color.setHex(data.facadeDB[state.facadeIdx].color);
        // –ü—Ä–æ—Å—Ç–æ–π —ç—Ñ—Ñ–µ–∫—Ç –≥–ª—è–Ω—Ü–∞
        matFacade.roughness = data.facadeDB[state.facadeIdx].glossy ? 0.1 : 0.8;
        matFacade.metalness = data.facadeDB[state.facadeIdx].glossy ? 0.3 : 0.0;

        renderer.render(scene, camera);

        // CALC PRICE
        const area = ((state.w*state.h*2) + (state.w*state.d*2) + (state.h*state.d*2)) / 1e6;
        // –¶–µ–Ω–∞ = (–ü–ª–æ—â–∞–¥—å * –¶–µ–Ω–∞–ö–æ—Ä–ø—É—Å–∞) + (–ü–ª–æ—â–∞–¥—å–§–∞—Å–∞–¥–∞ * –¶–µ–Ω–∞–§–∞—Å–∞–¥–∞) / —É–ø—Ä–æ—â–µ–Ω–Ω–æ
        const basePrice = (area * data.carcassDB[state.carcassIdx].price * 0.7) + (area * data.facadeDB[state.facadeIdx].price * 0.3);
        document.getElementById('total-price').innerText = Math.round(basePrice * 1.3).toLocaleString('ru-RU');

        if (!tg.MainButton.isVisible) { tg.MainButton.setText("–û–§–û–†–ú–ò–¢–¨ –ó–ê–ö–ê–ó"); tg.MainButton.show(); }
    }

    tg.MainButton.onClick(() => {
        const orderData = {
            name: "Model",
            dimensions: { width: state.w, height: state.h, depth: state.d },
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–≤–∞ –º–∞—Ç–µ—Ä–∏–∞–ª–∞
            carcass_material: data.carcassDB[state.carcassIdx].name,
            facade_material: data.facadeDB[state.facadeIdx].name,
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞–ø–æ–ª–Ω–µ–Ω–∏–µ
            filling: { section1: fill1.value, section2: fill2.value }
        };
        tg.sendData(JSON.stringify(orderData));
    });

    // Camera Controls
    let isDown=false, startX; const cvs = document.getElementById('canvas-3d');
    cvs.addEventListener('mousedown', e=>{isDown=true; startX=e.clientX;}); window.addEventListener('mouseup',()=>isDown=false);
    cvs.addEventListener('touchstart', e=>{isDown=true; startX=e.touches[0].clientX;}); window.addEventListener('touchend',()=>isDown=false);
    const moveCamera = (clientX) => { if(!isDown)return; const d=(clientX-startX)*0.005; camera.position.x=camera.position.x*Math.cos(d)-camera.position.z*Math.sin(d); camera.position.z=camera.position.x*Math.sin(d)+camera.position.z*Math.cos(d); camera.lookAt(0,1000,0); startX=clientX; renderer.render(scene, camera); };
    window.addEventListener('mousemove',e=>moveCamera(e.clientX)); window.addEventListener('touchmove',e=>moveCamera(e.touches[0].clientX));
    window.addEventListener('resize', ()=>{renderer.setSize(cvs.clientWidth, cvs.clientHeight); camera.aspect=cvs.clientWidth/cvs.clientHeight; camera.updateProjectionMatrix(); renderer.render(scene, camera);});
    
    updateAll();
</script>
</body>
</html>
